<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpXjpnWFYg4fwoBeK9lxP9GvIXF8M6Ecw6mBfdE3vjN9VKrnwnssHbIN78szgV2Jr3IEpdoXpo-wa5/pub?gid=461187973&single=true&output=csv";
  const IMAGES_PER_PAGE = 15;

  const CSV_URL = "./data.csv";  // or just "data.csv" if in same folder

  let imageData = [];
  let currentPage = 1;

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
  }

  // Simple CSV parser supporting quoted fields with commas
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const rows = [];
    const regex = /("([^"]|"")*"|[^,]*)(,|$)/g;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const row = [];
      let match;
      while ((match = regex.exec(line)) !== null) {
        let field = match[1];
        if (field.startsWith('"') && field.endsWith('"')) {
          field = field.slice(1, -1).replace(/""/g, '"');
        }
        row.push(field);
        if (match[3] === '') break;
      }
      rows.push(row);
    }
    return rows;
  }

  function fetchCSVData() {
    fetch(CSV_URL)
      .then(response => response.text())
      .then(data => {
        const rows = parseCSV(data).slice(1); // skip header
        imageData = rows.map(cols => ({
          slug: (cols[0] || "").trim(),
          imageUrl: (cols[1] || "").trim(),
          description: (cols[2] || "").trim(),
          theme: (cols[3] || "").trim(),
          galleryUrl: (cols[4] || "#").trim()
        })).filter(item => item.imageUrl && item.imageUrl.startsWith("http"));

        console.log(imageData); // debug
        renderGallery();
      })
      .catch(err => console.error("Failed to load CSV:", err));
  }

  function renderGallery() {
    const startIndex = (currentPage - 1) * IMAGES_PER_PAGE;
    const endIndex = startIndex + IMAGES_PER_PAGE;
    const pageItems = imageData.slice(startIndex, endIndex);

    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";

    pageItems.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <a href="${item.galleryUrl}" target="_blank" rel="noopener noreferrer">
          <img src="${item.imageUrl}" alt="${item.slug}" />
        </a>
        <h3>${item.slug}</h3>
        <p>${item.description}</p>
      `;
      gallery.appendChild(card);
    });

    document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${Math.ceil(imageData.length / IMAGES_PER_PAGE)}`;
    document.getElementById("prevBtn").disabled = currentPage === 1;
    document.getElementById("nextBtn").disabled = endIndex >= imageData.length;
  }

  function nextPage() {
    currentPage++;
    renderGallery();
  }

  function prevPage() {
    currentPage--;
    renderGallery();
  }

  fetchCSVData();
</script>
